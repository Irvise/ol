<html>
<head>
</head>
<body>
<script>
   IPOS = 8;
   SPOS = 16;
   TPOS = 2;
   RPOS = 11;


   W = 4; // javascript is 32-bit machine
   F = function(val) { return (((word)(val) << IPOS) | 2) }
   FBITS = (W*8) - 8;
   HIGHBIT = 1 << FBITS;
   FMAX = HIGHBIT - 1;
   RAWBIT = 1 << RPOS;
   RAWH = function(t) { return t | (RAWBIT >> TPOS) }

   make_value = function(type, value) { return (value << IPOS) | (type << TPOS)  | 2 }
   make_header = function(type, size) { return ( size << SPOS) | (type << TPOS)  | 2 }
   make_raw_header = function(type, size, p) { return (size << SPOS) | (type << TPOS) | (RAWBIT) | (p << 8) | 2 }

   // is_value
   // is_reference
   // is_rawobject
   // hdrsize
   // padsize
   // thetype
   // valuetype
   // reftype
   // 

   TPAIR     =  1;
   TTUPLE    =  2;
   TSTRING   =  3;
   TSYMBOL   =  4;
   TPORT     = 12;
   TCONST    = 13;
   TBYTECODE = 16;
   TPROC     = 17;
   TCLOS     = 18;

   // ...

   IFALSE = make_value(TCONST, 0)
   ITRUE  = make_value(TCONST, 1)
   INULL  = make_value(TCONST, 2)
   IEMPTY = make_value(TCONST, 3)
   IEOF   = make_value(TCONST, 4)
   IHALT  = INULL
   IRETURN= make_value(TCONST, 6)

   NR = 256;


   ol = {
      R: new Array(NR),
      this: {},
      arity: 0
   };


   function count_fasl_objects(bootstrap) {
      var hp = 0;
      var decode_word = function() {
         var nat = 0;
         var i;
         do {
            nat <<= 7;
            i = bootstrap[hp++];
            nat = nat + (i & 127);
         }
         while (i & 128);
         return nat;
      }

      var n = 0;
      while (bootstrap[hp] != 0) {
         switch (bootstrap[hp++]) {
            case 1: {
               hp++;
               var size = decode_word();
               while (size--) {
                  if (bootstrap[hp] == 0)
                     hp += 2;
                  decode_word();
               }
               break;
            }
            case 2: {
               hp++;
               var size = decode_word();
               hp += size;

               break;
            }
            default: {
               console.log("Bad object in heap");
            }
         }
         n++;
      };

      return n;
   };

   var oReq = new XMLHttpRequest();
   oReq.open("GET", "/repl", true);

   oReq.responseType = "arraybuffer";

   oReq.onload = function (oEvent) {
      var arrayBuffer = oReq.response; // Note: not oReq.responseText
      if (arrayBuffer) {
         var bootstrap = new Uint8Array(arrayBuffer);

         // займемся десериализацией образа

         // предварительный подсчет
         var nobjs = count_fasl_objects(bootstrap);

         console.log(nobjs);

         // десериализация
         // deserialize(nobjs, bootstrap);


         alert("ok");
         /*for (var i = 0; i < byteArray.byteLength; i++) {
            // do something with each byte in the array
         }*/
      }
   };
   oReq.send(null);
</script>
</body>
</html>