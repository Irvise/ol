<!DOCTYPE HTML>
<head>
   <meta charset="utf-8" />
   <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <title>OL</title>
   <meta name="author" content="Yuriy Chumak - yuriy-chumak"/>

   <script src="static/jquery-1.11.3.min.js"></script>
   <link  href="static/jquery.terminal.css" rel="stylesheet"/>
   <script src="static/jquery.terminal-0.8.8.min.js"></script>
   <script src="static/jquery.mousewheel.min.js"></script>

   <!--<script src="settings.js"></script>-->
   <!--
   
   <script src="library.js"></script>
   <script src="utility.js"></script>-->

   <!--[if IE]>
   <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
   <![endif]-->

   <style type="text/css">
      .emscripten {
         position: absolute;
         height: 100vh;
         width: 100vw;
         top: 0;
         left: 0;
         background-color: black;
      }
   </style>
</head>
<body style="height: 100%; margin: 0">
   <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()"></canvas>

   <div id="terminal"></div>
   <script>
   $(document).keydown(function(e) {
      if (e.keyCode === 27/*192*/) {
         if ($("#terminal").is(":visible")) {
            $("#terminal").hide();
            terminal.pause();
         }
         else {
            $("#terminal").show();
            terminal.resume();
         }

         e.preventDefault();
      }
   });
   </script>


   <script>
var stdInput = ""; //unescape(encodeURIComponent(",load \"init.lisp\"")); // loading the script with initial code

//EMTSTACKTOP = 0; // TEMP

var terminal;
$('#terminal').terminal(function(command, terminal) {
   stdInput += unescape(encodeURIComponent(command));

   // let's clear prompt up to got response
   terminal.set_prompt('');
}, {
   prompt: '> ',
   name: 'repl',
   greetings: '\
OL - Otus Lisp - yet another pet lisp\n\
Copyright(c) 2014 Aki Helin\n\
Copyright(c) 2014 - 2018 Yuriy Chumak\n\
~~~~~~~~~~~~~~~~~\n',
   enabled: false,
   height: 200,

   onInit: function(term) {
      terminal = term;
      terminal.ready = false;
   }
});

$('#terminal').mousewheel(function(event) {
   terminal.scroll(event.deltaY);
   // console.log(event.deltaX, event.deltaY, event.deltaFactor);
   if (event.preventDefault)  //disable default wheel action of scrolling page
      event.preventDefault();
   else
      return false;
});
   </script>

   <!-- Ol loader ----------------------------------------------------------- -->
   <script type='text/javascript'>
      // https://kripken.github.io/emscripten-site/docs/api_reference/module.html
      /*var LibraryManager = {};
      function mergeInto(obj, other) {
         for (var i in other) {
            obj["_" + i] = other[i];
            // asmLibraryArg["_" + i] = other[i]
         }
         var postset = other["$GL__postset"];
         //if (postset != undefined) eval(postset);

         return obj;
      }*/

      var Module = {
         //arguments: ['/repl', 'test.lisp', '--interactive'],
         arguments: ['/repl', '-', '--interactive'],
         //dynamicLibraries: ['library_xlib.js'],
         preRun: function() {
            console.log("preRun");
            //LibraryManager.library = Module;

            function stdin() {
               if (stdInput.length == 0) {
                  return undefined;
               }

               var chr = stdInput.charCodeAt(0);
               stdInput = stdInput.substring(1);
               return chr;
            }
            var stdout = null;
            var stderr = null;
            FS.init(stdin, stdout, stderr);

            Libraries.forEach( function(i) {
               console.log("i: ", i.path + "/" + i.name);
               if (i.path != "/")
                  FS.createPath("/", i.path, true, true);
               FS.createDataFile(i.path + "/", i.name, i.data, true, false);
            });
            // cleanup?
            //Libraries = [];


            //loadDynamicLibrary("library_gl.js");
            //loadDynamicLibrary("library_xlib.js");
            //var GLctx; GL.init()
         },
         postRun: function() {
            console.log("postRun");
            terminal.focus();
            terminal.resume();

            terminal.exec(",load \"init.lisp\"");
         },

         print: function(text) {
            if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');

            // let's process OL's prompt:
            terminal.set_prompt('> ');
            terminal.position(1);
            while (text.indexOf("> ") == 0)
               text = text.substring(2);
            terminal.echo(text);

            // this: hide terminal when first empty line received
            if (!terminal.ready && text=="") {
               terminal.ready = true;
               $("#terminal").hide();
               terminal.pause();
            }
         },
         printErr: function(text) {
            console.log("error: ", text);
            terminal.error(text);

            $("#terminal").show();
         },
         canvas: (function() {
            var canvas = document.getElementById('canvas');

            // As a default initial behavior, pop up an alert when webgl context is lost. To make your
            // application robust, you may want to override this behavior before shipping!
            // See http://www.khronos.org/registry/webgl/specs/latest/1.0/#5.15.2
            canvas.addEventListener("webglcontextlost", function(e) { alert('WebGL context lost. You will need to reload the page.'); e.preventDefault(); }, false);
            return canvas;
         })(),

         setStatus: function(text) {
            console.log("status: ", text);
         },

         totalDependencies: 0,
         noExitRuntime: 0,

         onAbort: function(text) {
            console.log("abort: ", text);
         },

         monitorRunDependencies: function(left) {
            console.log("monitorRunDependencies: ", left);
            // this.totalDependencies = Math.max(this.totalDependencies, left);
            // Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
         }
      };
      Module.setStatus('Downloading...');
      window.onerror = function(event) {
         // TODO: do not warn on ok events like simulating an infinite loop or exitStatus
         Module.setStatus('onerror: Exception thrown, see JavaScript console', event);
         //spinnerElement.style.display = 'none';
         Module.setStatus = function(text) {
            if (text) Module.printErr('[post-exception status] ' + text);
         };
      };
   </script>

   <script>
var Libraries = [
      { path: "/otus", name: "ffi.scm",    file: "otus/ffi.scm" },
      { path: "/lib",  name: "opengl.scm", file: "lib/opengl.scm" },

      { path: "/EGL",       name: "version-1-1.scm", file: "EGL/version-1-1.scm" },
      { path: "/OpenGL/ES", name: "version-1-1.scm", file: "OpenGL/ES/version-1-1.scm" },

      { path: "/", name: "init.lisp", file: "init.lisp" },
      { path: "/", name: "repl", file: "repl" }
   ];
var Downloaded = 0;

   Libraries.forEach( function(item) {
      $.ajax({
         url: item.file,
         type: 'GET',
         beforeSend: function (xhr) {
            xhr.overrideMimeType("text/plain; charset=x-user-defined");
         },
         success: function( data ) {
            console.log("ok: ", item.name)
            item.data = data;

            if (++Downloaded == Libraries.length) {
               // load olvm
               var script = document.createElement('script');
               script.src = "../../olvm.js";
            
               script.addEventListener('load', function(me) {
                  terminal.echo("Loading...")
               }, false);
               script.addEventListener('error', function(event) {
                  terminal.echo("Can't find olvm.js. Please, build it first and try again.")
               }, false);
            
               document.body.appendChild(script);
            }
         }
      });
   });
   /* for release:
   (function() {
     var memoryInitializer = 'olvm.html.mem';
     if (typeof Module['locateFile'] === 'function') {
       memoryInitializer = Module['locateFile'](memoryInitializer);
     } else if (Module['memoryInitializerPrefixURL']) {
       memoryInitializer = Module['memoryInitializerPrefixURL'] + memoryInitializer;
     }
     var xhr = Module['memoryInitializerRequest'] = new XMLHttpRequest();
     xhr.open('GET', memoryInitializer, true);
     xhr.responseType = 'arraybuffer';
     xhr.send(null);
   })();//*/
   </script>
</body>
</html>
